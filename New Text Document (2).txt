<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatientFlow ‚Äì Strict Department Visibility & Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #e4edf5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .app-wrapper {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 40px;
            box-shadow: 0 30px 60px -20px rgba(0,55,120,0.3);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.6);
        }

        .app-header {
            background: linear-gradient(145deg, #0a2a4a, #0f3a5e);
            color: white;
            padding: 18px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .app-header h1 {
            font-size: 26px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .patient-selector {
            background: rgba(255,255,255,0.12);
            padding: 8px 20px;
            border-radius: 60px;
            display: flex;
            align-items: center;
            gap: 16px;
            backdrop-filter: blur(4px);
        }

        #patientDropdown {
            padding: 10px 18px;
            border-radius: 40px;
            border: none;
            background: white;
            font-weight: 600;
            color: #0a3252;
            min-width: 200px;
            border: 1px solid #aac4e0;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 40px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            background: white;
            color: #0f3a5e;
        }

        .btn-primary {
            background: #ffb347;
            color: #1e3b5a;
            border: none;
            box-shadow: 0 4px 12px rgba(255,180,70,0.4);
        }

        .btn-primary:hover {
            background: #ffa01c;
            transform: scale(1.02);
        }

        .container {
            display: flex;
            height: calc(90vh - 85px);
            min-height: 600px;
        }

        .sidebar {
            width: 280px;
            background: #0f1e2f;
            color: #f1f5f9;
            padding: 28px 22px;
            display: flex;
            flex-direction: column;
        }

        .sidebar h3 {
            font-weight: 500;
            font-size: 18px;
            margin-bottom: 16px;
            color: #c2d6ed;
            border-bottom: 1px solid #2d4a6a;
            padding-bottom: 12px;
        }

        .sidebar select {
            width: 100%;
            padding: 12px 16px;
            background: #1e324a;
            border: 1px solid #3f5e7c;
            color: white;
            border-radius: 18px;
            font-size: 16px;
            cursor: pointer;
        }

        .main {
            flex: 1;
            padding: 28px 32px;
            overflow-y: auto;
            background: #f6fbfe;
        }

        .card {
            background: white;
            padding: 24px 28px;
            border-radius: 28px;
            margin-bottom: 28px;
            box-shadow: 0 6px 22px rgba(0,45,85,0.04);
            border: 1px solid #e6f0fa;
        }

        .patient-header-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            background: linear-gradient(105deg, #f0f8ff, white);
        }

        .patient-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 12px;
            background: #f0f7fe;
            padding: 20px;
            border-radius: 24px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-group label {
            font-size: 12px;
            font-weight: 700;
            color: #256ba0;
            text-transform: uppercase;
        }

        .patient-input {
            padding: 10px 16px;
            border-radius: 30px;
            border: 1px solid #c7def7;
            font-size: 15px;
            background: white;
            min-width: 180px;
        }

        .datetime-picker {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 18px 22px;
            border-radius: 40px;
            margin-top: 16px;
        }

        .timeline-item {
            border-left: 5px solid #2a73e8;
            padding-left: 22px;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 1px solid #dbeafe;
        }

        .status {
            padding: 6px 16px;
            border-radius: 60px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }

        .pending { background: #f2a83a; color: white; }
        .inprogress { background: #2a73e8; color: white; }
        .completed { background: #1f8b4c; color: white; }

        .action-buttons {
            margin-top: 18px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .btn-status {
            padding: 10px 24px;
            border-radius: 60px;
            font-weight: 700;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-inprogress {
            background: #2a73e8;
            color: white;
        }

        .btn-inprogress:hover {
            background: #1d5fc0;
            transform: scale(1.02);
        }

        .btn-completed {
            background: #1f8b4c;
            color: white;
        }

        .btn-completed:hover {
            background: #15703b;
            transform: scale(1.02);
        }

        .patient-badge {
            background: #1f4682;
            color: white;
            padding: 8px 24px;
            border-radius: 60px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 48px;
            background: #f2faff;
            border-radius: 32px;
            color: #54738f;
        }

        .dept-tag {
            background: #e2effb; 
            padding: 4px 16px; 
            border-radius: 60px; 
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .doctor-view-notice {
            background: #fef7e6;
            border-left: 6px solid #ffb347;
            padding: 16px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #5a4a1e;
        }
    </style>
</head>
<body>
<div class="app-wrapper">
    <!-- Header with multi-patient management -->
    <div class="app-header">
        <h1>
            <span>üè• PatientFlow</span>
            <span style="font-size: 16px; background: #1d5980; padding: 5px 18px; border-radius: 60px;">Strict Dept Control</span>
        </h1>
        <div class="patient-selector">
            <span style="color: white;">üë• ACTIVE PATIENT:</span>
            <select id="patientDropdown" onchange="switchActivePatient()"></select>
            <button class="btn btn-primary" onclick="showCreatePatientModal()">‚ûï NEW PATIENT</button>
        </div>
    </div>

    <div class="container">
        <!-- SIDEBAR: Role selector -->
        <div class="sidebar">
            <h3>üë§ CARE TEAM ROLE</h3>
            <select id="roleSelect" onchange="renderView()">
                <option value="Doctor">Doctor (View Only)</option>
                <option value="Nurse">Nurse</option>
                <option value="Lab">Lab</option>
                <option value="Pharmacy">Pharmacy</option>
            </select>
            <div style="margin-top: 40px; color: #b8d0e0; font-size: 14px; border-top: 1px solid #2a4560; padding-top: 24px;">
                <span style="display: block; margin-bottom: 16px;">üìã Active patient summary</span>
                <div id="sidebarPatientSummary" style="background: #1a314a; padding: 16px; border-radius: 20px;"></div>
            </div>
            <div style="margin-top: 30px; background: #17324b; border-radius: 18px; padding: 16px;">
                <span style="color: #ffd966;">üîí STRICT POLICY:</span>
                <span style="display: block; margin-top: 10px; color: #c2d9f0; font-size: 13px;">
                    ‚Ä¢ Each department sees ONLY their own orders<br>
                    ‚Ä¢ ONLY the assigned department can change status<br>
                    ‚Ä¢ Doctor can view all orders but CANNOT modify
                </span>
            </div>
        </div>

        <!-- MAIN PANEL -->
        <div class="main">
            <!-- PATIENT INFO CARD (editable) -->
            <div class="card patient-header-card">
                <div style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h2 id="patientNameHeader">John Doe</h2>
                        <span class="patient-badge" id="patientIdHeader">ID: P001</span>
                    </div>
                    
                    <div class="patient-fields">
                        <div class="field-group">
                            <label>FULL NAME</label>
                            <input type="text" id="editPatientName" class="patient-input" value="John Doe">
                        </div>
                        <div class="field-group">
                            <label>AGE</label>
                            <input type="number" id="editPatientAge" class="patient-input" value="45" style="width:100px;">
                        </div>
                        <div class="field-group">
                            <label>DIAGNOSIS</label>
                            <input type="text" id="editPatientDiagnosis" class="patient-input" value="Suspected Pneumonia" style="min-width:220px;">
                        </div>
                        <div class="field-group">
                            <label>PATIENT ID</label>
                            <input type="text" id="editPatientId" class="patient-input" value="P001" style="width:110px;">
                        </div>
                        <div class="field-group" style="justify-content: flex-end;">
                            <button class="btn" style="background: #1e5a9b; color: white; margin-top: 16px;" onclick="updateCurrentPatientInfo()">üíæ UPDATE PATIENT</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CREATE ORDER CARD -->
            <div class="card action-card">
                <h3 style="display: flex; gap: 8px;">‚ûï CREATE ORDER ‚Äî for <span id="activePatientNameInOrder" style="background: #d1e6ff; padding: 4px 16px; border-radius: 60px;">John Doe</span></h3>
                
                <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 8px;">
                    <select id="actionType" style="padding: 12px 20px; border-radius: 60px; border: 1px solid #b8d6f2; background: white; flex:1;">
                        <option value="Prescription">üíä Prescription</option>
                        <option value="Lab Request">üß™ Lab Request</option>
                        <option value="Imaging">üñ•Ô∏è Imaging</option>
                        <option value="Referral">üìã Referral</option>
                        <option value="Care Instruction">üìå Care Instruction</option>
                    </select>
                    <input type="text" id="actionDetails" placeholder="e.g., Amoxicillin 500mg, CBC, chest X-ray..." style="flex: 2; padding: 12px 20px; border-radius: 60px; border: 1px solid #b8d6f2;">
                </div>

                <div class="datetime-picker">
                    <span style="font-weight: 600; color: #0f456b;">‚è±Ô∏è ORDER TIMESTAMP:</span>
                    <input type="datetime-local" id="customOrderTime" value="2026-02-12T14:30">
                    <button class="btn-primary" style="background: #1e6eb5; color: white; padding: 12px 28px;" onclick="addActionForCurrentPatient()">‚úì PLACE ORDER</button>
                </div>
                <p style="font-size: 13px; margin-top: 12px; color: #256ba0;">‚ìò Order will be assigned to the responsible department. Only that department can see and update it.</p>
            </div>

            <!-- TIMELINE CARD - STRICT VISIBILITY & CONTROL -->
            <div class="card">
                <h3>üìã CARE TIMELINE ¬∑ <span id="timelinePatientName">John Doe</span>
                    <span style="margin-left: 16px; background: #2a6e9b; color: white; padding: 4px 16px; border-radius: 60px; font-size: 14px;" id="roleIndicator">Role: Doctor (View Only)</span>
                </h3>
                
                <!-- Doctor view notice -->
                <div id="doctorViewNotice" class="doctor-view-notice" style="display: none;">
                    üëÅÔ∏è <strong>Doctor View:</strong> You can see all orders for this patient, but you cannot modify status. Only the assigned department can update orders.
                </div>
                
                <div id="timeline"></div>
                <div id="emptyTimelineMsg" class="empty-state" style="display: none;">üì≠ No orders visible for this role.</div>
            </div>
        </div>
    </div>
</div>

<script>
    // -------------------------------------------------------------
    // PATIENTFLOW ‚Äî STRICT DEPARTMENT VISIBILITY & CONTROL
    // -------------------------------------------------------------
    // RULES:
    // 1. Doctor: sees ALL orders for the patient, but NO status buttons (view-only)
    // 2. Nurse/Lab/Pharmacy: sees ONLY orders where department matches their role
    // 3. ONLY the assigned department sees status buttons (In Progress/Completed)
    // 4. No other role can modify status - Doctor cannot change anything
    // -------------------------------------------------------------
    
    // ---------- DATA STORE ----------
    let patients = [];
    let activePatientId = null;
    let orders = [];

    // ---------- INITIALIZE with sample patients & orders ----------
    function initializeData() {
        patients = [
            { id: 'P001', name: 'John Doe', age: 45, diagnosis: 'Suspected Pneumonia', mrn: 'P001' },
            { id: 'P002', name: 'Emma Watson', age: 58, diagnosis: 'Type 2 Diabetes, HTN', mrn: 'P002' },
            { id: 'P003', name: 'Carlos Ruiz', age: 32, diagnosis: 'Fractured Tibia', mrn: 'P003' }
        ];

        orders = [
            { id: 1001, patientId: 'P001', type: 'Lab Request', details: 'CBC, CRP, blood culture', department: 'Lab', status: 'Completed', timestamp: 'Feb 10 ¬∑ 08:15' },
            { id: 1002, patientId: 'P001', type: 'Prescription', details: 'Amoxicillin 500mg', department: 'Pharmacy', status: 'In Progress', timestamp: 'Feb 11 ¬∑ 11:20' },
            { id: 1003, patientId: 'P002', type: 'Prescription', details: 'Metformin 500mg, Lisinopril', department: 'Pharmacy', status: 'Pending', timestamp: 'Feb 12 ¬∑ 09:10' },
            { id: 1004, patientId: 'P002', type: 'Lab Request', details: 'HbA1c, Lipid panel', department: 'Lab', status: 'Pending', timestamp: 'Feb 12 ¬∑ 10:30' },
            { id: 1005, patientId: 'P003', type: 'Imaging', details: 'X-ray tibia/fibula', department: 'Lab', status: 'In Progress', timestamp: 'Feb 11 ¬∑ 14:15' },
            { id: 1006, patientId: 'P003', type: 'Care Instruction', details: 'Elevate leg, ice pack', department: 'Nurse', status: 'Pending', timestamp: 'Feb 12 ¬∑ 08:45' }
        ];

        if (patients.length > 0) activePatientId = patients[0].id;
    }

    // ---------- GET ACTIVE PATIENT ----------
    function getActivePatient() {
        return patients.find(p => p.id === activePatientId) || patients[0];
    }

    // ---------- REFRESH PATIENT DROPDOWN ----------
    function refreshPatientDropdown() {
        const dropdown = document.getElementById('patientDropdown');
        dropdown.innerHTML = '';
        patients.forEach(pat => {
            const option = document.createElement('option');
            option.value = pat.id;
            option.textContent = `${pat.name} (${pat.id})`;
            if (pat.id === activePatientId) option.selected = true;
            dropdown.appendChild(option);
        });
    }

    // ---------- SWITCH ACTIVE PATIENT ----------
    function switchActivePatient() {
        const dropdown = document.getElementById('patientDropdown');
        activePatientId = dropdown.value;
        refreshAllPatientUI();
        renderView();
    }

    // ---------- REFRESH UI with active patient data ----------
    function refreshAllPatientUI() {
        const patient = getActivePatient();
        if (!patient) return;

        document.getElementById('patientNameHeader').innerText = patient.name;
        document.getElementById('patientIdHeader').innerText = `ID: ${patient.id}`;
        document.getElementById('activePatientNameInOrder').innerText = patient.name;
        document.getElementById('timelinePatientName').innerText = patient.name;
        document.getElementById('sidebarPatientSummary').innerHTML = `
            <span style="display: block; font-weight: 700; font-size: 16px;">${patient.name}</span>
            <span style="display: block; margin-top: 8px; color: #b8d6ed;">Age: ${patient.age || '‚Äî'}</span>
            <span style="display: block; color: #b8d6ed;">Diagnosis: ${patient.diagnosis || '‚Äî'}</span>
            <span style="display: block; margin-top: 12px; background: #0e3e5c; padding: 6px 12px; border-radius: 30px;">üÜî ${patient.id}</span>
        `;

        document.getElementById('editPatientName').value = patient.name || '';
        document.getElementById('editPatientAge').value = patient.age || '';
        document.getElementById('editPatientDiagnosis').value = patient.diagnosis || '';
        document.getElementById('editPatientId').value = patient.id || '';
    }

    // ---------- UPDATE CURRENT PATIENT INFO ----------
    function updateCurrentPatientInfo() {
        const patient = getActivePatient();
        if (!patient) return;

        const newName = document.getElementById('editPatientName').value.trim();
        const newAge = document.getElementById('editPatientAge').value;
        const newDiagnosis = document.getElementById('editPatientDiagnosis').value.trim();
        const newId = document.getElementById('editPatientId').value.trim();

        if (!newName || !newId) {
            alert('Patient name and ID are required');
            return;
        }

        const existingPatient = patients.find(p => p.id === newId && p.id !== patient.id);
        if (existingPatient) {
            alert(`Patient ID ${newId} already exists. Choose another.`);
            return;
        }

        patient.name = newName;
        patient.age = newAge ? parseInt(newAge) : null;
        patient.diagnosis = newDiagnosis;
        const oldId = patient.id;
        patient.id = newId;

        if (oldId !== newId) {
            orders.forEach(order => {
                if (order.patientId === oldId) order.patientId = newId;
            });
        }

        refreshPatientDropdown();
        refreshAllPatientUI();
        renderView();
    }

    // ---------- CREATE NEW PATIENT ----------
    function showCreatePatientModal() {
        const newName = prompt('Enter new patient full name:', 'James Smith');
        if (!newName) return;
        const newAge = prompt('Enter age:', '52');
        const newDiagnosis = prompt('Enter diagnosis:', 'COPD');
        
        const existingIds = patients.map(p => p.id);
        let newId = '';
        let counter = patients.length + 1;
        while (!newId) {
            const candidate = `P${String(counter).padStart(3, '0')}`;
            if (!existingIds.includes(candidate)) {
                newId = candidate;
            } else {
                counter++;
            }
        }

        const newPatient = {
            id: newId,
            name: newName,
            age: newAge ? parseInt(newAge) : null,
            diagnosis: newDiagnosis || 'Not specified',
            mrn: newId
        };

        patients.push(newPatient);
        refreshPatientDropdown();
        activePatientId = newId;
        refreshPatientDropdown();
        refreshAllPatientUI();
        renderView();
        alert(`‚úÖ New patient ${newName} (${newId}) created.`);
    }

    // ---------- DEPARTMENT MAPPING ----------
    function getDepartment(type) {
        const map = {
            "Prescription": "Pharmacy",
            "Lab Request": "Lab",
            "Imaging": "Lab",
            "Referral": "Doctor",
            "Care Instruction": "Nurse"
        };
        return map[type] || "Doctor";
    }

    // ---------- FORMAT DATETIME ----------
    function formatCustomDatetime(datetimeString) {
        if (!datetimeString) return null;
        const date = new Date(datetimeString);
        if (isNaN(date.getTime())) return null;
        return date.toLocaleString('en-US', { 
            month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit', hour12: false 
        }).replace(',', ' ¬∑');
    }

    // ---------- ADD ORDER FOR CURRENT PATIENT ----------
    function addActionForCurrentPatient() {
        const activePatient = getActivePatient();
        if (!activePatient) { alert('No active patient'); return; }

        const type = document.getElementById('actionType').value;
        const details = document.getElementById('actionDetails').value.trim();
        if (!details) { alert('Please enter order details'); return; }

        let customTimeValue = document.getElementById('customOrderTime').value;
        let finalTimestamp;

        if (customTimeValue) {
            const formatted = formatCustomDatetime(customTimeValue);
            finalTimestamp = formatted || new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', ' ¬∑');
        } else {
            finalTimestamp = new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', ' ¬∑');
        }

        const newOrder = {
            id: Date.now() + Math.floor(Math.random() * 1000),
            patientId: activePatient.id,
            type: type,
            details: details,
            department: getDepartment(type),
            status: 'Pending',
            timestamp: finalTimestamp,
            rawDateTime: customTimeValue
        };

        orders.push(newOrder);
        document.getElementById('actionDetails').value = '';
        renderView();
    }

    // ---------- UPDATE ORDER STATUS (only called from department buttons) ----------
    function updateStatus(orderId, newStatus) {
        const order = orders.find(o => o.id === orderId);
        if (order) {
            order.status = newStatus;
            renderView();
        }
    }

    // ---------- RENDER VIEW - STRICT VISIBILITY & CONTROL ----------
    function renderView() {
        const role = document.getElementById('roleSelect').value;
        document.getElementById('roleIndicator').innerText = `Role: ${role} ${role === 'Doctor' ? '(View Only)' : ''}`;
        
        // Show/hide doctor notice
        const doctorNotice = document.getElementById('doctorViewNotice');
        if (role === 'Doctor') {
            doctorNotice.style.display = 'block';
        } else {
            doctorNotice.style.display = 'none';
        }

        const activePatient = getActivePatient();
        if (!activePatient) return;

        refreshAllPatientUI();

        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';

        // ---------------------------------------------------------
        // STRICT FILTERING RULE:
        // - Doctor: sees ALL orders for this patient (no filter)
        // - Other roles: sees ONLY orders where department === role
        // ---------------------------------------------------------
        let filteredOrders = orders.filter(order => order.patientId === activePatient.id);
        
        if (role !== 'Doctor') {
            filteredOrders = filteredOrders.filter(order => order.department === role);
        }

        const emptyMsg = document.getElementById('emptyTimelineMsg');
        if (filteredOrders.length === 0) {
            emptyMsg.style.display = 'block';
            timeline.appendChild(emptyMsg);
        } else {
            emptyMsg.style.display = 'none';
            filteredOrders.sort((a,b) => a.id - b.id).forEach(order => {
                const div = document.createElement('div');
                div.className = 'timeline-item';

                let statusClass = '';
                if (order.status === 'Pending') statusClass = 'pending';
                else if (order.status === 'In Progress') statusClass = 'inprogress';
                else if (order.status === 'Completed') statusClass = 'completed';

                const deptBadge = `<span class="dept-tag">üè• ${order.department}</span>`;
                const statusBadge = `<span class="status ${statusClass}">${order.status}</span>`;

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                        <span style="font-size: 1.2rem; font-weight: 700; color: #0a3858;">${order.type}</span>
                        ${statusBadge}
                    </div>
                    <div style="margin: 12px 0; background: #f3fafe; padding: 14px 18px; border-radius: 24px;">
                        üìå ${order.details}
                    </div>
                    <div style="display: flex; gap: 18px; align-items: center; flex-wrap: wrap;">
                        ${deptBadge}
                        <span style="color: #2d6190; background: #eef5fc; padding: 4px 16px; border-radius: 40px;">üïí ${order.timestamp}</span>
                    </div>
                `;

                // ---------------------------------------------------------
                // STRICT STATUS BUTTON RULE:
                // - ONLY show buttons if role matches order.department
                // - Doctor NEVER gets buttons (view-only)
                // - Only assigned department can mark In Progress/Completed
                // ---------------------------------------------------------
                if (order.status !== 'Completed' && role === order.department) {
                    const btnDiv = document.createElement('div');
                    btnDiv.className = 'action-buttons';

                    // Mark In Progress button (only if not already In Progress)
                    if (order.status !== 'In Progress') {
                        const progressBtn = document.createElement('button');
                        progressBtn.innerText = '‚è≥ Mark In Progress';
                        progressBtn.className = 'btn-status btn-inprogress';
                        progressBtn.onclick = (e) => { 
                            e.stopPropagation(); 
                            updateStatus(order.id, 'In Progress'); 
                        };
                        btnDiv.appendChild(progressBtn);
                    }

                    // Mark Completed button
                    const completeBtn = document.createElement('button');
                    completeBtn.innerText = '‚úÖ Mark Completed';
                    completeBtn.className = 'btn-status btn-completed';
                    completeBtn.onclick = (e) => { 
                        e.stopPropagation(); 
                        updateStatus(order.id, 'Completed'); 
                    };
                    btnDiv.appendChild(completeBtn);

                    div.appendChild(btnDiv);
                }

                timeline.appendChild(div);
            });
        }
    }

    // ---------- GLOBAL FUNCTION EXPOSURE ----------
    window.switchActivePatient = switchActivePatient;
    window.showCreatePatientModal = showCreatePatientModal;
    window.updateCurrentPatientInfo = updateCurrentPatientInfo;
    window.addActionForCurrentPatient = addActionForCurrentPatient;
    window.renderView = renderView;
    window.updateStatus = updateStatus;

    // ---------- ON LOAD ----------
    window.onload = function() {
        initializeData();
        refreshPatientDropdown();
        
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth()+1).padStart(2,'0');
        const day = String(now.getDate()).padStart(2,'0');
        const hours = String(now.getHours()).padStart(2,'0');
        const minutes = String(now.getMinutes()).padStart(2,'0');
        document.getElementById('customOrderTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;

        refreshAllPatientUI();
        renderView();
    };
</script>

<!-- Download link generator (this page itself is not the download) -->
</body>
</html>